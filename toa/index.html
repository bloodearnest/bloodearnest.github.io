<html>
	<head>
		<meta charset="utf-8">
		<title>Tomb of Annihiliation Campaign</title>
		<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/normalize/8.0.0/normalize.min.css">
		<link rel="stylesheet" href="https://bloodearnest.github.io/athack/fonts.css">
		<link rel="stylesheet" href="toa.css">
	</head>
	<body>
		<ul>
			<li><a href="/dnd5e-quickref">Combat actions quick reference</a></li>
			<li><a href="https://docs.google.com/spreadsheets/d/1eXPtvE3rvwDW2_cXVK3M_OPjx1BLk-pVoFA_F2hD2ZI/edit">Party Inventory</a></li>
			<li><a href="https://www.dropbox.com/sh/oarzj1cay273238/AAASZsyhxq4hqAS6vPjp9wB6a?dl=0">Dropbox Folder</a>
			<li><a href="rest.html">Resting Checklist</a></li>
		</ul>
		<table class="characters">
			<thead>
				<tr>
					<th>Name</th>
					<th colspan="3"></th>
					<th><button id="longrest">Long Rest</button></th>
					<th></th>
					<th><label title="Airnel can maximise your hit dice at the cost of a use of a healers kit">Max</label></th>
					<th><label title="Airnel can expend a use of a Healers kit to heal you 1d6+4+level">Kit</label></th>
					<th id="songofrest"><button>SoR</button></th>
					<th id="hp">HP</th>
					<th id="healingkits">Kits: <input name="kits" type="number" min=0></th>
				</tr>
			</thead>
			<tbody>
				<tr class="character" id="timber">
					<td class="name">Timber</td>
					<td><a href="Timber.jpg"><img src="Timber.jpg"></a></td>
					<td><a href="https://www.dndbeyond.com/characters/1119096"><img src="dndbeyond.jpg"></a></td>
					<td><a href="/athack/#Timber"><span class="athack">@</span></a></td>
					<td class="left">
						<input name="current" type="number" dir="rtl" min="0"> /
						<span class="maxdie">7</span>
						<span class="die">d10+1</span>
					</td>
					<td class="left"><input name="number" type="number" dir="rtl" min="0" value="1"></td>
					<td><input name="maximise" type="checkbox"></td>
					<td><input name="kit" type="checkbox"></td>
					<td><button class="button" type="button">Roll</button></td>
					<td><span class="result"></span></td>
				</tr>
				<tr class="character" id="nordan">
					<td class="name">Nordan</td>
					<td><a href="Nordan.jpg"><img src="Nordan.jpg"></a></td>
					<td><a href="https://www.dndbeyond.com/characters/1133678"><img src="dndbeyond.jpg"></a></td>
					<td><a href="/athack/#Nordan"><span class="athack">@</span></a></td>
					<td class="left">
						<input name="current" type="number" dir="rtl" min="0"> /
						<span class="maxdie">7</span>
						<span class="die">d8+2</span>
						<input type="hidden" name="minimum" value="4">
					</td>
					<td class="left"><input name="number" type="number" dir="rtl" min="0" value="1"></td>
					<td><input name="maximise" type="checkbox"></td>
					<td><input name="kit" type="checkbox"></td>
					<td><button type="button">Roll</button></td>
					<td><span class="result"></span></td>
				</tr>
				<tr class="character" id="corminar">
					<td class="name">Corminar</td>
					<td><a href="Corminar.jpg"><img src="Corminar.jpg"></a></td>
					<td><a href="https://www.dndbeyond.com/characters/1339195"><img src="dndbeyond.jpg"></a></td>
					<td><a href="/athack/#Corminar"><span class="athack">@</span></a></td>
					<td class="left">
						<input name="current" type="number" dir="rtl" min="0"> /
						<span class="maxdie">7</span>
						<span class="die">d8+1</span>
					</td>
					<td class="left"><input name="number" type="number" dir="rtl" min="0" value="1"></td>
					<td><input name="maximise" type="checkbox"></td>
					<td><input name="kit" type="checkbox"></td>
					<td><button type="button">Roll</button></td>
					<td><span class="result"></span></td>
				</tr>
				<tr class="character" id="airnel">
					<td class="name">Airnel</td>
					<td><a href="Airnel.jpg"><img src="Airnel.jpg"></a></td>
					<td><a href="https://www.dndbeyond.com/characters/1183264"><img src="dndbeyond.jpg"></a></td>
					<td><a href="/athack/#Airnel"><span class="athack">@</span></a></td>
					<td class="left">
						<input name="current" type="number" dir="rtl" min="0"> /
						<span class="maxdie">7</span>
						<span class="die">d8+1</span>
					</td>
					<td class="left"><input name="number" type="number" dir="rtl" min="0" value="1"></td>
					<td><input name="maximise" type="checkbox"></td>
					<td><input name="kit" type="checkbox"></td>
					<td><button type="button">Roll</button></td>
					<td><span class="result"></span></td>
					<td>
					</td>
				</tr>
				<tr class="character" id="">
					<td class="name">Grondrath</td>
					<td><a href="Grondrath.jpg"><img src="Grondrath.jpg"></a></td>
					<td><a href="https://www.dndbeyond.com/characters/6579686"><img src="dndbeyond.jpg"></a></td>
					<td><a href="/athack/#Grondrath"><span class="athack">@</span></a></td>
					<td class="left">
						<input name="current" type="number" dir="rtl" min="0"> /
						<span class="maxdie">7</span>
						<span class="die">d12+4</span>
					</td>
					<td class="left"><input name="number" type="number" dir="rtl" min="0" value="1"></td>
					<td><input name="maximise" type="checkbox"></td>
					<td><input name="kit" type="checkbox"></td>
					<td><button type="button">Roll</button></td>
					<td><span class="result"></span></td>
				</tr>
				<tr class="character" id="thorin">
					<td class="name">Thorin</td>
					<td><a href="Thorin.jpg"><img src="Thorin.jpg"></a></td>
					<td><a href="https://www.dndbeyond.com/characters/1149756"><img src="dndbeyond.jpg"></a></td>
					<td><a href="/athack/#Thorin"><span class="athack">@</span></a></td>
					<td class="left">
						<input name="current" type="number" dir="rtl" min="0"> /
						<span class="maxdie">7</span>
						<span class="die">d10+3</span>
					</td>
					<td class="left"><input name="number" type="number" dir="rtl" min="0" value="1"></td>
					<td><input name="maximise" type="checkbox"></td>
					<td><input name="kit" type="checkbox"></td>
					<td><button type="button">Roll</button></td>
					<td><span class="result"></span></td>
				</tr>
				<tr class="character" id="daz">
					<td class="name">Daz</td>
					<td><a href="daz.jpg"><img src="daz.jpg"></a></td>
					<td></td>
					<td><a href="/athack/#Thorin"><span class="athack">@</span></a></td>
					<td class="left">
						<input name="current" type="number" dir="rtl" min="0"> /
						<span class="maxdie">4</span>
						<span class="die">d10+3</span>
					</td>
					<td class="left"><input name="number" type="number" dir="rtl" min="0" value="1"></td>
					<td><input name="maximise" type="checkbox"></td>
					<td><input name="kit" type="checkbox"></td>
					<td><button type="button">Roll</button></td>
					<td><span class="result"></span></td>
				</tr>

			</tbody>
		</table>
		<script type="text/javascript" src="https://bloodearnest.github.io/athack/dnd.js"></script>
		<script type="text/javascript" src="https://unpkg.com/peerjs@1.0.0/dist/peerjs.min.js"></script>
		<script type="text/javascript">

var roll = function(die_text, annotated, die_func) {
	let parts = Array.from(parse_dice(die_text))
	var score = 0;
	for (let {n, size} of parts) {
		score += roll_dice(n, size, annotated, false, die_func);
	}
	return score;
};

var CHANGE = new Event('change');
var set_value = function(elem, value) {
	elem.value = parseInt(value);
	elem.dispatchEvent(CHANGE);
}

var ensure_local = function(name, _default) {
	var value = window.localStorage.getItem(name);
	if (value === "undefined" || value === null) {
		window.localStorage.setItem(name, _default);
		return _default;
	}
	else {
		return value;
	}
}

var setup = function(pc) {
	var roll_button = pc.querySelector('button');
	var max_hd = parseInt(pc.querySelector('span.maxdie').innerText);
	var current = pc.querySelector('input[name=current]');
	var num = pc.querySelector('input[name=number]');
	var result = pc.querySelector('span.result');
	var maximise = pc.querySelector('input[name=maximise]');
	var kit = pc.querySelector('input[name=kit]');

	current.max = max_hd;
	current.onchange = function() {
		window.localStorage.setItem(pc.id, parseInt(current.value));
		num.max = current.value;
		num.value = Math.min(current.value, 1);
		return true;
	};

	var initial_hd = ensure_local(pc.id, max_hd);
	set_value(current, initial_hd);

	// fixed values
	var die_text = pc.querySelector('span.die').innerText;
	var die_func = die;
	var minimum = pc.querySelector('input[name=minimum]');
	if (minimum) {
		var min = parseInt(minimum.value);
		die_func = function(n) {
			var r = die(n);
			return r > min ? r : min;
		}
	}

	roll_button.onclick = function() {
		var score = 0;
		var kits_used = 0;
		var df = die_func;
		if (maximise.checked) {
			df = Math.max;
			kits_used += 1;
		}

		var annotated = [];
		for (var i = 0; i < num.value; i++) {
			score += roll(die_text, annotated, df);
		}
		if (kit.checked) {
			kits_used += 1;
			var r = die(6);
			score += r + 4 + max_hd;
			annotated.push(`1d6 (${r})`);
			annotated.push('4');
			annotated.push(`${max_hd}`);
		}
		if (sor.value) {
			score += parseInt(sor.value);
			annotated.push(`1d6 (${sor.value})`);
		}

		var new_value = current.value -= num.value;
		set_value(current, new_value);
		set_value(healing_kits, parseInt(healing_kits.value) + kits_used);
		result.innerText = score;
		console.log(annotated);
		return false;
	};

};

var chars = document.querySelectorAll('.characters tr.character');
chars.forEach(setup);

var longrest = document.querySelector('#longrest');
longrest.onclick = function() {
	chars.forEach(function(pc) {
		var max_hd = parseInt(pc.querySelector('span.maxdie').innerText);
		var to_add = Math.floor(max_hd / 2);
		var current = pc.querySelector('input[name=current]');
		set_value(current, Math.min(parseInt(current.value) + to_add, current.max));
	});
};
var sor = document.querySelector('#songofrest button');
sor.onclick = function() {
	var r = die(6);
	sor.innerText = `SoR: ${r}`;
	sor.value = r;
}

var healing_kits = document.querySelector('#healingkits input');
healing_kits.onchange = function() {
	window.localStorage.setItem('healingkits', healing_kits.value);
	return true;
}
set_value(healing_kits, ensure_local('healingkits', 0));


var maximise_cbs = document.querySelectorAll('input[name=maximise]');
maximise_cbs.forEach(function(cb) {
	cb.onchange = function() {
		maximise_cbs.forEach(function(cb2) {
			if (cb !== cb2) {
				cb2.checked = false;
			}
		});
	};
});
		</script>
	</body>
</html>
